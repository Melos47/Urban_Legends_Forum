# 🧪 三大功能测试指南

## 问题修复总结

### ✅ 已修复的问题：

1. **通知弹窗系统**
   - 前端添加了 `checkNotifications()` 函数
   - 每30秒自动检查新通知
   - 登录成功后立即检查通知
   - 有新通知时会弹出Toast提示

2. **证据生成触发逻辑**
   - 修改了证据生成条件：从"只有0个证据时生成"改为"评论数达到阈值倍数时生成"
   - 现在每2、4、6、8...条评论都会生成新证据
   - 包括图片和音频证据

3. **故事自动生成**
   - 定时器正常工作（每6分钟）
   - 提供了手动生成脚本用于测试

---

## 📋 测试步骤

### 测试1: 通知弹窗 ✅

1. **登录用户账号**
   ```
   访问 http://127.0.0.1:5001
   点击"登录"按钮
   输入用户名和密码
   ```

2. **查看通知**
   - 登录成功后，如果有未读通知，会立即弹出Toast
   - 右上角会显示通知图标（如果有）

3. **触发新通知**
   - 在某个故事下发表评论
   - 等待5秒，AI楼主会回复
   - 你会收到"AI楼主回复了你"的通知弹窗

**预期结果**: 
- ✅ 登录后立即看到未读通知弹窗
- ✅ AI回复后30秒内收到通知弹窗
- ✅ 弹窗显示在右上角，蓝色背景

---

### 测试2: 证据生成与显示 🎬

**当前状态**:
- 故事#1 已有 23条评论
- 故事#1 已有 2个图片证据
- 故事#1 没有音频证据

**测试步骤**:

1. **访问故事详情**
   ```
   打开 http://127.0.0.1:5001
   点击第一个故事
   ```

2. **查看现有证据**
   - 应该能看到2张图片
   - 目前没有音频

3. **发表评论触发音频生成**
   - 在故事下方发表一条评论（现在有24条）
   - 评论数24是2的倍数，会触发证据生成
   - 等待约30-60秒（图片生成）+ 2秒（音频生成）

4. **刷新页面查看新证据**
   - 关闭故事详情窗口
   - 重新点击故事
   - 应该能看到新增的证据（可能是图片或音频）

**预期结果**:
- ✅ 第24条评论后自动生成新证据
- ✅ 刷新后能看到新证据（包括音频播放器）
- ✅ 音频是1.5秒的诡异环境音（不是TTS朗读）

---

### 测试3: 定时生成故事 ⏰

**方法A: 等待自动生成（6分钟）**

1. **记录当前故事数**
   ```bash
   访问首页，查看"总档案数"
   当前应该是 3 个故事
   ```

2. **等待6分钟**
   - 服务器会在启动后6分钟自动生成新故事
   - 可以在终端看到生成日志

3. **刷新页面**
   - 6分钟后刷新首页
   - 故事数应该增加到 4
   - 会看到Toast提示"🎃 有1个新故事发布了！"

**方法B: 手动触发（测试用）**

1. **运行手动生成脚本**
   ```bash
   cd /Users/siqi/Documents/PolyU/Sem1/SD5913/FinalCode
   .venv/bin/python manual_generate_story.py
   ```

2. **查看生成结果**
   - 脚本会显示新故事的标题、ID等信息

3. **刷新页面验证**
   - 回到浏览器刷新首页
   - 应该能看到新故事

**预期结果**:
- ✅ 每6分钟自动生成一个新故事
- ✅ 新故事出现在首页顶部
- ✅ 弹出Toast提示有新故事
- ✅ 总故事数增加

---

## 🔍 调试工具

### 查看系统状态
```bash
cd /Users/siqi/Documents/PolyU/Sem1/SD5913/FinalCode
.venv/bin/python test_features.py
```

**输出示例**:
```
============================================================
🧪 功能测试报告
============================================================

【测试1】通知系统
  📊 总通知数: 11
  📬 未读通知: 2

【测试2】证据系统
  📊 总证据数: 3  ← 应该会增加
  🔊 音频证据: 1  ← 新增音频
  📸 图片证据: 2

【测试3】故事生成
  📊 总故事数: 4  ← 应该会增加
  🤖 AI生成故事: 4
  ⏱️  最新故事: 1分钟前  ← 应该很新
```

---

## ❗ 常见问题

### Q1: 通知弹窗没有出现？
**A**: 
- 检查是否已登录（必须登录才能收到通知）
- 打开浏览器控制台（F12），查看是否有JavaScript错误
- 刷新页面，重新登录

### Q2: 音频证据没有生成？
**A**:
- 确认评论数是否达到2的倍数（2、4、6、8...）
- 查看服务器终端，是否有生成日志
- 等待约1分钟后刷新故事详情页面

### Q3: 6分钟后没有新故事？
**A**:
- 检查服务器终端，查看是否有错误日志
- LM Studio可能没有运行，使用手动生成脚本测试
- 查看.env文件，确认STORY_GEN_INTERVAL_MINUTES=6

---

## 📊 技术细节

### 通知系统流程
```
用户发表评论 → AI回复 → 创建通知记录 → 
前端每30秒轮询 → 检测到新通知 → 显示Toast弹窗
```

### 证据生成流程
```
评论数 % 2 == 0 → 启动后台线程 →
生成图片（30-60秒）+ 生成音频（2秒）→
保存到数据库 → 刷新页面可见
```

### 故事生成流程
```
APScheduler定时器（6分钟）→ 
调用LM Studio生成文本 → 
创建Story记录 → 
前端自动检测并弹窗提示
```

---

## ✅ 验收标准

全部功能正常的标志：

1. ✅ 登录后立即看到未读通知弹窗
2. ✅ 发表评论后收到AI回复通知
3. ✅ 24条评论后生成新证据（包括音频）
4. ✅ 每6分钟自动生成新故事并弹窗提示
5. ✅ 前端每30秒自动刷新数据

---

**测试时间**: 2025-11-09 21:15
**服务器地址**: http://127.0.0.1:5001
**定时器间隔**: 6分钟
**证据阈值**: 2条评论
