<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯æ®æ˜¾ç¤ºè¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .story-card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .evidence-item {
            border: 2px solid #ddd;
            padding: 10px;
            background: #fafafa;
        }
        .evidence-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        .status.ok { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .info { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <h1>ğŸ” è¯æ®æ˜¾ç¤ºè¯Šæ–­å·¥å…·</h1>
    <p class="info">æ­¤é¡µé¢ç”¨äºè¯Šæ–­è¯æ®æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</p>
    
    <div id="diagnostics"></div>
    
    <script>
        async function runDiagnostics() {
            const container = document.getElementById('diagnostics');
            
            // æµ‹è¯•æ‰€æœ‰AIç”Ÿæˆçš„æ•…äº‹
            const storiesResponse = await fetch('/api/stories?per_page=20');
            const storiesData = await storiesResponse.json();
            const stories = storiesData.stories || storiesData;
            
            let html = '<h2>ğŸ“Š æ‰€æœ‰å¸–å­çš„è¯æ®çŠ¶æ€</h2>';
            
            for (const story of stories.filter(s => s.id <= 15)) {
                // è·å–å®Œæ•´æ•…äº‹è¯¦æƒ…
                const detailResponse = await fetch(`/api/stories/${story.id}`);
                const detail = await detailResponse.json();
                
                const evidenceCount = (detail.evidence || []).length;
                const commentCount = (detail.comments || []).filter(c => !c.is_ai_response).length;
                
                html += `<div class="story-card">`;
                html += `<h3>æ•…äº‹ #${story.id}: ${detail.title}</h3>`;
                html += `<p class="info">è¯„è®ºæ•°: ${commentCount} | è¯æ®æ•°: ${evidenceCount}</p>`;
                
                if (evidenceCount > 0) {
                    html += `<div class="evidence-grid">`;
                    
                    for (const e of detail.evidence) {
                        html += `<div class="evidence-item">`;
                        html += `<p><strong>è¯æ® #${e.id}</strong></p>`;
                        html += `<p class="info">è·¯å¾„: ${e.file_path}</p>`;
                        
                        // å°è¯•åŠ è½½å›¾ç‰‡
                        html += `<img src="${e.file_path}" 
                            onerror="this.parentElement.innerHTML += '<p class=\\"status error\\">å›¾ç‰‡åŠ è½½å¤±è´¥</p>'"
                            onload="this.parentElement.innerHTML += '<p class=\\"status ok\\">å›¾ç‰‡åŠ è½½æˆåŠŸ</p>'">`;
                        html += `<p class="info">${e.description}</p>`;
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                } else if (commentCount >= 2 && commentCount % 2 === 0) {
                    html += `<p class="status error">âš ï¸ åº”è¯¥ç”Ÿæˆè¯æ®ä½†è¿˜æ²¡æœ‰</p>`;
                } else {
                    html += `<p class="info">ç­‰å¾…æ›´å¤šè¯„è®ºè§¦å‘è¯æ®ç”Ÿæˆ (éœ€è¦ ${2 - (commentCount % 2)} æ¡è¯„è®º)</p>`;
                }
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œè¯Šæ–­
        runDiagnostics();
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(runDiagnostics, 30000);
    </script>
</body>
</html>
